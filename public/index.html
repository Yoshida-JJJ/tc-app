<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA MCP Agent - Google Analytics AIåˆ†æãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .input-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .query-input {
            height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .results-section {
            padding: 30px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .result-card h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .result-card pre {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.4;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .examples {
            margin-top: 20px;
        }

        .example-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .example-query {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-query:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .example-query h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .status-bar {
            background: #e9ecef;
            padding: 15px;
            border-top: 1px solid #dee2e6;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– GA MCP Agent</h1>
            <p>Google Analytics ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªç„¶è¨€èªã§åˆ†æã™ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div style="text-align: center; margin-bottom: 20px;">
                    <a href="chat.html" class="btn btn-primary" style="text-decoration: none; padding: 15px 30px; display: inline-block; margin-right: 15px;">
                        ğŸ’¬ ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹
                    </a>
                    <span style="color: #666; font-size: 14px;">ã¾ãŸã¯å¾“æ¥ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨</span>
                </div>
                <div class="input-group">
                    <label for="viewId">Google Analytics ãƒ“ãƒ¥ãƒ¼ID</label>
                    <input type="text" id="viewId" placeholder="ä¾‹: 123456789">
                </div>

                <div class="input-group">
                    <label for="query">è³ªå•ãƒ»åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ</label>
                    <textarea id="query" class="query-input" placeholder="ä¾‹: å…ˆæœˆã®äººæ°—ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—10ã‚’æ•™ãˆã¦"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="analyzeQuery()">ğŸ” åˆ†æå®Ÿè¡Œ</button>
                    <button class="btn btn-secondary" onclick="interpretQuery()">ğŸ’­ è³ªå•è§£æ</button>
                    <button class="btn btn-secondary" onclick="authenticate()">ğŸ”‘ Googleèªè¨¼</button>
                    <button class="btn btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                </div>

                <div class="examples">
                    <h3>ã‚µãƒ³ãƒ—ãƒ«è³ªå•</h3>
                    <div class="example-queries">
                        <div class="example-query" onclick="setExampleQuery(this)">
                            <h4>äººæ°—ãƒšãƒ¼ã‚¸åˆ†æ</h4>
                            <p>ä»Šæœˆã®äººæ°—ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—10ã¨ãã‚Œãã‚Œã®æ»åœ¨æ™‚é–“ã‚’æ•™ãˆã¦</p>
                        </div>
                        <div class="example-query" onclick="setExampleQuery(this)">
                            <h4>ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†æ</h4>
                            <p>éå»30æ—¥ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æºã¨æµå…¥æ•°ã‚’åˆ†æã—ã¦</p>
                        </div>
                        <div class="example-query" onclick="setExampleQuery(this)">
                            <h4>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</h4>
                            <p>ä»Šæœˆã¨å…ˆæœˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’æ¯”è¼ƒã—ã¦</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>åˆ†æä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
            </div>

            <div class="results-section" id="results">
                <!-- Results will be displayed here -->
            </div>

            <div class="status-bar">
                <span id="status">å¾…æ©Ÿä¸­ - è³ªå•ã‚’å…¥åŠ›ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</span>
            </div>
        </div>
    </div>

    <script>
        function setExampleQuery(element) {
            const query = element.querySelector('p').textContent;
            document.getElementById('query').value = query;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('results').style.display = 'none';
            updateStatus('å¾…æ©Ÿä¸­ - è³ªå•ã‚’å…¥åŠ›ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
        }

        function authenticate() {
            window.open('/auth/google', '_blank', 'width=600,height=600');
        }

        function displayResults(data, title) {
            const resultsDiv = document.getElementById('results');
            
            const card = document.createElement('div');
            card.className = 'result-card';
            
            const cardTitle = document.createElement('h3');
            cardTitle.textContent = title;
            card.appendChild(cardTitle);
            
            const content = document.createElement('pre');
            content.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            card.appendChild(content);
            
            resultsDiv.appendChild(card);
        }

        function displayError(error) {
            const resultsDiv = document.getElementById('results');
            
            const card = document.createElement('div');
            card.className = 'result-card error';
            
            const cardTitle = document.createElement('h3');
            cardTitle.textContent = 'ã‚¨ãƒ©ãƒ¼';
            card.appendChild(cardTitle);
            
            const content = document.createElement('p');
            content.textContent = error;
            card.appendChild(content);
            
            resultsDiv.appendChild(card);
        }

        async function analyzeQuery() {
            const viewId = document.getElementById('viewId').value.trim();
            const query = document.getElementById('query').value.trim();

            if (!viewId || !query) {
                alert('ãƒ“ãƒ¥ãƒ¼IDã¨è³ªå•ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            updateStatus('AIåˆ†æä¸­...');
            clearResults();

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ viewId, query })
                });

                const result = await response.json();

                if (result.success) {
                    updateStatus('åˆ†æå®Œäº†');
                    
                    // AIåˆ†æçµæœã‚’è¡¨ç¤º
                    displayResults(result.analysis.aiAnalysis, 'AIåˆ†æçµæœ');
                    
                    // ãƒ‡ãƒ¼ã‚¿å–å¾—çµæœã‚’è¡¨ç¤º
                    Object.entries(result.data).forEach(([tool, data]) => {
                        displayResults(data, `ãƒ‡ãƒ¼ã‚¿ (${tool})`);
                    });
                    
                    // ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
                    displayResults(result.report.report, 'è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ');

                } else {
                    throw new Error(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                }

            } catch (error) {
                console.error('Analysis error:', error);
                displayError(`åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        async function interpretQuery() {
            const query = document.getElementById('query').value.trim();

            if (!query) {
                alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            updateStatus('è³ªå•è§£æä¸­...');
            clearResults();

            try {
                const response = await fetch('/api/interpret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                const result = await response.json();
                
                updateStatus('è§£æå®Œäº†');
                displayResults(result, 'è³ªå•è§£æçµæœ');

            } catch (error) {
                console.error('Interpretation error:', error);
                displayError(`è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        window.onload = async function() {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                
                if (health.status === 'OK') {
                    updateStatus('ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ - åˆ†ææº–å‚™å®Œäº†');
                } else {
                    updateStatus('ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                }
            } catch (error) {
                updateStatus('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
            }
        };
    </script>
</body>
</html>